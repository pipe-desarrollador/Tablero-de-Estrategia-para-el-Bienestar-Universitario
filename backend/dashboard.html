<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tablero – Consumo de /api/data y /api/stats</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
    body { margin: 24px; background:#0b0f14; color:#e7eef7; }
    h1 { margin: 0 0 6px; font-size: clamp(20px, 2.5vw, 28px); }
    .card { background:#111826; border:1px solid #1e293b; border-radius:12px; padding:16px; box-shadow: 0 10px 30px rgba(0,0,0,.15);} 
    .grid { display:grid; gap:16px; }
    .grid.cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    label { font-size:12px; opacity:.8; }
    input, select, button { padding:8px 10px; border-radius:8px; border:1px solid #334155; background:#0f172a; color:#e7eef7; }
    button { cursor:pointer; border-color:#475569; }
    button.primary { background:#2563eb; border-color:#2563eb; }
    button.secondary { background:#0f172a; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:8px 10px; border-bottom:1px solid #1f2937; text-align:left; font-size:14px; }
    th { background:#0f172a; position:sticky; top:0; }
    small.mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; opacity:.8; }
    .muted { opacity:.8; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #334155; font-size:12px; }
    .loading { opacity:.7; animation: pulse 1.2s ease-in-out infinite; }
    @keyframes pulse { 0% { opacity:.5 } 50% { opacity:1 } 100% { opacity:.5 } }
    .scroll { max-height: 380px; overflow:auto; }
    .status { margin: 0 0 16px; font-size: 13px; }
    .ok { color: #34d399; }
    .bad { color: #f87171; }
  </style>
</head>
<body>
  <h1>Frontend – Consumo de API</h1>
  <div class="status">
    <span class="muted">API base:</span> <span id="apiBase" class="mono"></span>
    <span id="apiHealth" class="pill muted" style="margin-left:8px;">checking…</span>
    <a href="/api-docs" style="margin-left:8px;" class="muted">/api-docs</a>
  </div>
  <p class="muted">Esta página consulta <code>/api/data</code> y <code>/api/stats</code>. Puedes usarla con el backend encendido o en modo <b>datos de prueba</b>.</p>

  <div class="card" style="margin-bottom:16px">
    <div class="row" style="gap:16px; align-items:flex-end;">
      <div>
        <label>Género</label><br>
        <select id="fGender">
          <option value="">(todos)</option>
          <option>F</option>
          <option>M</option>
        </select>
      </div>
      <div>
        <label>Tipo de estrés</label><br>
        <input id="fStress" placeholder="Ej. Académico" />
      </div>
      <div>
        <label>Edad min</label><br>
        <input id="fAgeMin" type="number" min="0" placeholder="18" />
      </div>
      <div>
        <label>Edad max</label><br>
        <input id="fAgeMax" type="number" min="0" placeholder="25" />
      </div>
      <div>
        <label>Page size</label><br>
        <select id="fPageSize">
          <option>10</option>
          <option selected>20</option>
          <option>50</option>
          <option>100</option>
        </select>
      </div>
      <div>
        <label>Orden</label><br>
        <select id="fSortBy">
          <option>id</option>
          <option selected>age</option>
          <option>gender</option>
          <option>stress_type</option>
        </select>
      </div>
      <div>
        <label>Dirección</label><br>
        <select id="fSortDir">
          <option>asc</option>
          <option selected>desc</option>
        </select>
      </div>
      <div>
        <label>&nbsp;</label><br>
        <button class="primary" id="btnLoad">Cargar datos</button>
        <button class="secondary" id="btnToggleMock">Usar datos de prueba: <span id="mockLabel">OFF</span></button>
      </div>
    </div>
    <div style="margin-top:8px"><small class="mono">Columnas: id, gender, age, stress_type (puedes ampliar el backend para más).</small></div>
  </div>

  <div class="grid cols-3" style="margin-bottom:16px">
    <div class="card">
      <div class="muted">Total registros</div>
      <div id="statTotal" style="font-size:28px; font-weight:600">-</div>
      <div class="muted">Edad: <span id="statAge"></span></div>
    </div>
    <div class="card">
      <div class="muted" style="margin-bottom:8px">Por género</div>
      <div class="scroll">
        <table id="tblGender"><thead><tr><th>Género</th><th>Conteo</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
    <div class="card">
      <div class="muted" style="margin-bottom:8px">Por tipo de estrés</div>
      <div class="scroll">
        <table id="tblStress"><thead><tr><th>Tipo</th><th>Conteo</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between; margin-bottom:8px">
      <div class="muted">Resultados</div>
      <div class="pill"><span id="metaLabel" class="muted">page - / -</span></div>
    </div>
    <div class="scroll">
      <table id="tblData">
        <thead>
          <tr><th>ID</th><th>Género</th><th>Edad</th><th>Tipo Estrés</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    // ===================
    // Configuración de origen
    // ===================
    const API_BASE = (window.location.origin && window.location.origin.startsWith('http'))
      ? window.location.origin
      : 'http://localhost:3000';
    document.getElementById('apiBase').textContent = API_BASE;

    // ===================
    // Mock toggle
    // ===================
    let USE_MOCK = false; // cambia a true para usar datos de prueba

    const mockDataResponse = {
      data: [
        { id: 101, gender: 'F', age: 19, stress_type: 'Académico' },
        { id: 102, gender: 'M', age: 21, stress_type: 'Financiero' },
        { id: 103, gender: 'F', age: 22, stress_type: 'Académico' },
        { id: 104, gender: 'F', age: 23, stress_type: 'Familiar' },
        { id: 105, gender: 'M', age: 24, stress_type: 'Académico' }
      ],
      meta: { page: 1, pageSize: 20, total: 5, totalPages: 1, sort_by: 'age', sort_dir: 'asc', filters: {} }
    };

    const mockStatsResponse = {
      status: 'success',
      filters: { gender: null, stress_type: null, age_min: null, age_max: null },
      totals: { total: 5 },
      age: { min_age: 19, max_age: 24, avg_age: 21.8 },
      by_gender: [ { gender: 'F', count: 3 }, { gender: 'M', count: 2 } ],
      by_stress_type: [ { stress_type: 'Académico', count: 3 }, { stress_type: 'Financiero', count: 1 }, { stress_type: 'Familiar', count: 1 } ],
      likert_avgs: { sleep_problems: 3.12, headaches: 2.85, concentration_issues: 3.4, irritability: 2.97, palpitations: 2.1, sadness: 2.55, anxiety: 3.25 },
      coverage: { filled_gender: 5, filled_age: 5, filled_sleep_problems: 0, filled_headaches: 0, filled_concentration_issues: 0, filled_irritability: 0, filled_palpitations: 0, filled_sadness: 0, filled_anxiety: 0, filled_stress_type: 5 }
    };

    // ===================
    // Utilidades DOM
    // ===================
    const $ = (sel) => document.querySelector(sel);
    const setText = (sel, value) => { const el = $(sel); if (el) el.textContent = value; };

    function renderTableBody(tbody, rows, cols) {
      tbody.innerHTML = '';
      for (const r of rows) {
        const tr = document.createElement('tr');
        for (const c of cols) {
          const td = document.createElement('td');
          td.textContent = (r[c] ?? '') + '';
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
    }

    function paramsFromUI() {
      const q = new URLSearchParams();
      const gender = $('#fGender').value.trim();
      const stress = $('#fStress').value.trim();
      const ageMin = $('#fAgeMin').value.trim();
      const ageMax = $('#fAgeMax').value.trim();
      const pageSize = $('#fPageSize').value.trim();
      const sortBy = $('#fSortBy').value.trim();
      const sortDir = $('#fSortDir').value.trim();

      if (gender) q.set('gender', gender);
      if (stress) q.set('stress_type', stress);
      if (ageMin) q.set('age_min', ageMin);
      if (ageMax) q.set('age_max', ageMax);
      if (pageSize) q.set('pageSize', pageSize);
      if (sortBy) q.set('sort_by', sortBy);
      if (sortDir) q.set('sort_dir', sortDir);
      q.set('columns', 'id,gender,age,stress_type');
      return q.toString();
    }

    async function fetchJSON(url) {
      const r = await fetch(url);
      if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
      return r.json();
    }

    async function loadAll() {
      try {
        $('#btnLoad').classList.add('loading');
        setText('#metaLabel', 'cargando…');

        if (USE_MOCK) {
          await new Promise(r => setTimeout(r, 300));
          applyData(mockDataResponse);
          applyStats(mockStatsResponse);
          return;
        }

        const qs = paramsFromUI();
        const [data, stats] = await Promise.all([
          fetchJSON(`${API_BASE}/api/data?${qs}`),
          fetchJSON(`${API_BASE}/api/stats?${qs}`)
        ]);
        applyData(data);
        applyStats(stats);
      } catch (e) {
        console.error(e);
alert('Error cargando datos: ' + e.message + '\n\n' +
      'Sugerencia: abre este archivo como ' + API_BASE + '/dashboard.html\n' +
      '(o activa "datos de prueba").');
      } finally {
        $('#btnLoad').classList.remove('loading');
      }
    }

    function applyData(payload) {
      const rows = payload.data || [];
      const meta = payload.meta || { page: 1, pageSize: rows.length, total: rows.length, totalPages: 1 };
      setText('#metaLabel', `page ${meta.page} / ${meta.totalPages} – ${meta.total} filas`);
      renderTableBody($('#tblData tbody'), rows, ['id','gender','age','stress_type']);
    }

    function applyStats(stats) {
      setText('#statTotal', (stats?.totals?.total ?? 0));
      const a = stats?.age || {};
      setText('#statAge', `min ${a.min_age ?? '-'} • max ${a.max_age ?? '-'} • avg ${a.avg_age ?? '-'}`);
      renderTableBody($('#tblGender tbody'), stats?.by_gender || [], ['gender','count']);
      renderTableBody($('#tblStress tbody'), stats?.by_stress_type || [], ['stress_type','count']);
    }

    async function checkHealth() {
      try {
        const r = await fetch(`${API_BASE}/ping`);
        if (r.ok) {
          const t = await r.text();
          setText('#apiHealth', `OK: ${t}`);
          $('#apiHealth').classList.remove('bad');
          $('#apiHealth').classList.add('ok');
        } else {
          setText('#apiHealth', `ERR ${r.status}`);
          $('#apiHealth').classList.remove('ok');
          $('#apiHealth').classList.add('bad');
        }
      } catch (e) {
        setText('#apiHealth', 'sin conexión');
        $('#apiHealth').classList.remove('ok');
        $('#apiHealth').classList.add('bad');
      }
    }

    // Eventos UI
    $('#btnLoad').addEventListener('click', loadAll);
    $('#btnToggleMock').addEventListener('click', () => {
      USE_MOCK = !USE_MOCK;
      setText('#mockLabel', USE_MOCK ? 'ON' : 'OFF');
    });

    // Autocarga inicial
    checkHealth();
    setText('#mockLabel', USE_MOCK ? 'ON' : 'OFF');
    loadAll();
  </script>
</body>
</html>
